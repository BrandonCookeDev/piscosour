

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Testing</title>
    <link rel="stylesheet" type="text/css" href="../../css/main.css">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
  </head>
  <body>
    <section class="docs">
      <aside>

        <div class="logoContainer">
          <a href="../../index.html">
            <img src="../../images/logo.svg" class="logo" />
            Piscosour
          </a>

        </div>
        <ul class="main_menu">
          
            
            <li>
              <h4>General</h4>
              
                
                  
                    <a href="../../developers/what_is_piscosour.html">What is piscosour</a>
                  
                
              
                
                  
                    <a href="../../developers/get_started.html">Get started</a>
                  
                
              
                
                  
                    <a href="../../developers/.gitignore"></a>
                  
                
              
                
              
                
              
                
              
            </li>

            <li>
              <h4>Tutorials</h4>
              <ul>
              
                
              
                
              
                
              
                
              
                
              
                
                  
                  <li>
                    
                    <a href="../../developers/tutorials/pisco-website.html">Create WebSite Recipe</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/tutorials/img-empty-submenu.png"></a>
                    
                  </li>
                  
                
              
              </ul>
            </li>

            <li>
              <h4>Guides</h4>
              <ul>
              
                
              
                
              
                
              
                
              
                
                  
                  <li>
                    
                    <a href="../../developers/guides/01-contexts.html">Contexts</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/02-steps.html">Steps</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/03-flows.html">Flows</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/04-stages.html">Stages</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/05-parameters.html">Parameters</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/06-inquire.html">Inquire</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/07-plugins.html">Plugins</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/08-parameters_between_steps.html">Communication between steps</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/09-steps-advanced.html">Advanced features in steps</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/10-requirements.html">Requirements</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/11-configuration.html">Recipe Configuration</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/12-guidelines.html">Guidelines</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/13-analytics.html">Google Analytics Integration</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/14-logger.html">Logger</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/15-implementations.html">Implementations</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/16-testing.html" class="selected">Testing</a>
                    
                  </li>
                  
                  <li>
                    
                    <a href="../../developers/guides/17-glossary.html">Glossary</a>
                    
                  </li>
                  
                
              
                
              
              </ul>
            </li>

            
            <li>
              <h4>Plugins</h4>
              <ul>
                
                  
                
                  
                
                  
                
                  
                    
                    <li>
                      
                      <a href="../../developers/documents/context.html">context</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/fsutils.html">fsutils</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/inquirer.html">inquirer</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/installer.html">installer</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/launcher.html">launcher</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/os.html">os</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/piscosour.html">piscosour</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/skipper.html">skipper</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/stream-write-hook.html">stream-write-hook</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/system-checker.html">system-checker</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/system-saver.html">system-saver</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/test.html">test</a>
                      
                    </li>
                    
                    <li>
                      
                      <a href="../../developers/documents/userConfig.html">userConfig</a>
                      
                    </li>
                    
                  
                
                  
                
                  
                
              </ul>
            </li>
            
            
          
            
          
            
          
            
          
        </ul>

        
          
        
          
        
          
        
          
          <a href="../../users/get_started.html"
            class="switch_target">
            Docs for users
          </a>
          
        
      </aside>
      <article>
        <h1 id="testing-piscosour">Testing Piscosour</h1>
<p>There are to ways to test piscosour recipes: <code>unit testing</code> and <code>functional testing (integration)</code>. Both could be functional but the main difference is that <code>unit testing</code> runs as a node library inside the test and <code>functional testing (integration)</code> runs the recipe as a system executable using require(&#39;child_process&#39;).exec.</p>
<ol>
<li><a href="#unitTesting">Unit Testing</a></li>
<li><a href="#functionalTesting">Functional Testing (integration)</a></li>
</ol>
<h2 id="-a-name-unittesting-a-unit-testing"><a name="unitTesting"></a> Unit testing</h2>
<ol>
<li><a href="#testingSteps">Testing steps</a></li>
<li><a href="#testingPlugins">Testing plugins</a></li>
<li><a href="#testingContexts">Testing contexts</a></li>
</ol>
<p>Needed to test <code>steps</code>, <code>plugins</code> (coming soon) and <code>contexts</code> (coming soon)</p>
<ul>
<li>These tests reside on the <code>test</code> folder of a recipe module.</li>
<li>It just needs the recipe to be tested and its dependencies.</li>
<li>You could generate coverage with this kind of tests</li>
</ul>
<h3 id="-a-name-testingsteps-a-testing-steps"><a name="testingSteps"></a> Testing steps</h3>
<p>Steps only need dependency to piscosour on devDependencies. Add dependencies to mocha and chai too.</p>
<p><code>NOTE:</code> If you need a context definition for the step execution, then the dependency to the context has to be on devDependencies too. for example <code>pisco-contexts</code></p>
<p>package.json:</p>
<pre><code class="lang-json">{
  &quot;...&quot;:&quot;...&quot;,
  &quot;scripts&quot;: {
    &quot;deps&quot;: &quot;npm install&quot;,
    &quot;test&quot;: &quot;node_modules/.bin/mocha -u tdd --recursive&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;chai&quot;: &quot;*&quot;,
    &quot;mocha&quot;: &quot;*&quot;,
    &quot;piscosour&quot;: &quot;^1.0.0&quot;
  },
  &quot;...&quot;:&quot;...&quot;
}
</code></pre>
<p>Writing a test for piscosour. First require stepTester</p>
<pre><code class="lang-javascript"> const tester = require(&#39;piscosour/lib/tests/stepTester&#39;);
</code></pre>
<ol>
<li><a href="#command">command object</a></li>
<li><a href="#setLoggerLevel">setLoggerLevel(level) method</a></li>
<li><a href="#loadStep">loadStep(command) method</a></li>
<li><a href="#runStep">runStep(command) method</a></li>
</ol>
<h4 id="-a-name-command-a-command-object-"><a name="command"></a>command object.</h4>
<p>The command object is the configuration parameter that piscosour uses to run the test.</p>
<table>
<thead>
<tr>
<th>Param</th>
<th>Type</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>String</td>
<td>No</td>
<td>The name of the step</td>
</tr>
<tr>
<td>context</td>
<td>Array</td>
<td>Yes</td>
<td>Array of the contexts runned</td>
</tr>
<tr>
<td>baseDir</td>
<td>String</td>
<td>Yes</td>
<td>Folder where the step is going to be runned. Default is the root of the recipe.</td>
</tr>
<tr>
<td>params</td>
<td>Object</td>
<td>Yes</td>
<td>All params passed for the execution</td>
</tr>
</tbody>
</table>
<h4 id="-a-name-setloggerlevel-a-setloggerlevel-level-method"><a name="setLoggerLevel"></a>setLoggerLevel(level) method</h4>
<p><code>logger.setLoggerLevel(level)</code> set logger level for piscosour. <a href="./14-logger.html">See logger for more information</a></p>
<table>
<thead>
<tr>
<th>Param</th>
<th>Type</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>level</td>
<td>Number</td>
<td>No</td>
<td>0...5 log levels</td>
</tr>
</tbody>
</table>
<h4 id="-a-name-loadstep-a-loadstep-command-method"><a name="loadStep"></a>loadStep(command) method</h4>
<p><code>logger.loadStep(command)</code> Load local step with all plugins and all piscosour configuration. <strong>Returns</strong> step object with all piscosour features loaded.</p>
<table>
<thead>
<tr>
<th>Param</th>
<th>Type</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>command</td>
<td>Object</td>
<td>No</td>
<td>See <a href="#command">command object</a></td>
</tr>
</tbody>
</table>
<h4 id="-a-name-runstep-a-runstep-command-method"><a name="runStep"></a>runStep(command) method</h4>
<p><code>logger.runStep(command)</code> Run one local step from the recipe. <strong>Returns</strong> a promise with the execution of the step.</p>
<table>
<thead>
<tr>
<th>Param</th>
<th>Type</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>command</td>
<td>Object</td>
<td>No</td>
<td>See <a href="#command">command object</a></td>
</tr>
</tbody>
</table>
<p>This is a example of an entire test file.</p>
<pre><code class="lang-javascript">&#39;use strict&#39;;

const path = require(&#39;path&#39;);
const tester = require(&#39;piscosour/lib/tests/stepTester&#39;);
const expect = require(&#39;chai&#39;).expect;
const assert = require(&#39;assert&#39;);

/* global define, it, describe, before, beforeEach, afterEach, after */

// configure

tester.setLoggerLevel(0);

// constants

const stepName = &#39;askHello&#39;;
const contexts = [&#39;world&#39;];
const message = &#39;Unit Framework hola!&#39;;

describe(&#39;Unit testing framework for askHello step&#39;, () =&gt; {
  it(&#39;Should return the step to test&#39;, (done) =&gt; {
    const step = tester.loadStep({
      name: stepName,
      context: contexts
    });
    expect(step).not.equal(null);
    expect(step.name).to.equal(stepName);
    done();
  });
  it(&#39;Should run the step to test&#39;, (done) =&gt; {
    tester.setLoggerLevel(0);
    tester.runStep({
        name: stepName,
        context: contexts,
        baseDir: path.join(__dirname, &#39;world&#39;),
        params: {
          paramInquire: message
        }
      })
      .then(() =&gt; {
        done();
      })
      .catch((err) =&gt; {
        done(err);
      })
  });
  it(&#39;Should run the step with plugins to test&#39;, (done) =&gt; {
    tester.setLoggerLevel(0);
    tester.runStep({
        name: &#39;emittingHello&#39;,
        context: contexts,
        baseDir: path.join(__dirname, &#39;world&#39;),
        params: {
          paramInquire: message
        }
      })
      .then(() =&gt; {
        done();
      })
      .catch((err) =&gt; {
        done(err);
      })
  });
});
</code></pre>
<h3 id="-a-name-testingplugins-a-testing-plugins"><a name="testingPlugins"></a> Testing plugins</h3>
<p>(comming soon)</p>
<h3 id="-a-name-testingcontexts-a-testing-contexts"><a name="testingContexts"></a> Testing contexts</h3>
<p>(comming soon)</p>
<h2 id="-a-name-functionaltesting-a-functional-testing-integration-"><a name="functionalTesting"></a> Functional testing (integration)</h2>
<ol>
<li><a href="#configureRecipe">Configure the recipe</a></li>
<li><a href="#writeTest">Writing tests</a></li>
<li><a href="#runningTest">Running tests</a></li>
</ol>
<p>The functional testing features are:</p>
<ul>
<li>It is used to test only recipes by executing externally all its commands.</li>
<li>It is possible to test <code>flows</code> and <code>steps</code>.</li>
<li>Executes the recipe command so a configured environment is needed.</li>
<li>Tests are located on an external module, outside of the recipe. Test modules have to be dependencies of the recipe.</li>
</ul>
<h3 id="-a-name-configurerecipe-a-configuring-the-recipe-for-testing"><a name="configureRecipe"></a> Configuring the recipe for testing</h3>
<ol>
<li>Add <code>&quot;test&quot; : &quot;bin/pisco.js -ft&quot;</code> to the <code>scripts</code> object in package.json.</li>
<li>Add dependencies to one or more functional-testing modules.  </li>
</ol>
<p>Fragment of package.json of a recipe.</p>
<pre><code class="lang-json">{
  &quot;scripts&quot;: {
    &quot;deps&quot;: &quot;npm install&quot;,
    &quot;test&quot;: &quot;bin/pisco.js -ft&quot;
  },
  &quot;keywords&quot;: [
    &quot;piscosour-recipe&quot;
  ],
  &quot;bin&quot;: {
    &quot;cells&quot;: &quot;bin/pisco.js&quot;
  },
  &quot;dependencies&quot;: {
    &quot;piscosour&quot;: &quot;^1.1.0&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;pisco-functional-tests&quot;: &quot;^1.0.1-beta&quot;
  },
  &quot;...&quot;:&quot;...&quot;
}
</code></pre>
<h3 id="-a-name-writetest-a-writing-the-tests-the-functional-testing-module-"><a name="writeTest"></a> Writing the tests (the functional testing module)</h3>
<ul>
<li>This module must have <code>functional-tests</code> keyword</li>
<li>Dependencies to testing frameworks should be on dependencies not on devDependencies</li>
<li>Dependency to piscosour is not necessary.</li>
</ul>
<p>Fragment of package.json of the functional testing module:</p>
<pre><code class="lang-json">{
  &quot;...&quot;:&quot;...&quot;,
  &quot;keywords&quot;: [
    &quot;functional-tests&quot;
  ],
  &quot;dependencies&quot;: {
    &quot;chai&quot;: &quot;*&quot;,
    &quot;mocha&quot;: &quot;*&quot;
  },
  &quot;...&quot;:&quot;...&quot;
}
</code></pre>
<p>Now tests must execute the command <code>piscoExec</code> that is injected as an environment variable.</p>
<p>This is an example of tests that we can be written. This test proves the creation of an app using cells-cli recipe.</p>
<pre><code class="lang-javascript">&#39;use strict&#39;;

const pctp = require(&#39;pisco-callback-to-promise&#39;);
const u = require(&#39;../utils&#39;);

const fs = require(&#39;fs-extra&#39;);
const path = require(&#39;path&#39;);
const exec = require(&#39;child_process&#39;).exec;

/* global define, it, describe, before, beforeEach, afterEach, after */

// constants

const baseApp = `${__dirname}/../tmp`;

// ---- Tests --------

describe(&#39;Run cells app:create&#39;, function() {

  const allOk = &#39;[ create ] finished&#39;;
  this.timeout(6000);

  it(`Should create a list of apps and say &quot;${allOk}&quot; on all apps`, function(done) {
    pctp.c2p(fs.ensureDir, baseApp)
      .then(() =&gt; pctp.c2p(exec, `${process.env.piscoExec} app:create --scaffoldDir scaffold --appName test-app`, {cwd: baseApp}))
      .catch((err) =&gt; pctp.logError(err, done));
  });
  afterEach(&#39;Should delete the tmp directory&#39;, (done) =&gt; {
    u.remove([ baseApp ])
      .then(() =&gt; done());
  });
});
</code></pre>
<p>Let&#39;s see this example:</p>
<ul>
<li>Note that executable is a env variable: <code>process.env.piscoExec</code></li>
<li>We are using pctp module that converts callbacks to promises.</li>
</ul>
<h3 id="-a-name-runningtest-a-running-functional-tests"><a name="runningTest"></a> Running functional tests</h3>
<ul>
<li>From the recipe just with <code>npm test</code> or <code>bin/pisco.js -ft</code></li>
<li>In the functional testing module just executing mocha. First is needed to export the piscoExec parameter to environment:</li>
</ul>
<pre><code class="lang-bash">export piscoExec=&quot;node /Users/sbonacho/projects/cells-cli/bin/pisco.js&quot;
mocha -u tdd --recursive test --timeout 5000 --grep &quot;Unit testing framework for askHello step&quot;
</code></pre>
<p><code>NOTE:</code> Is possible to test docker by changing <code>piscoExec</code> value:</p>
<pre><code class="lang-bash">export piscoExec=&quot;docker run -ti --rm -p 8000-8100:8000-8100 -p 3000-3100:3000-3100 -v ~/.gradle:/home/pisco/.gradle -v ~/.bowerrc:/home/pisco/.bowerrc -v ~/.npmrc:/home/pisco/.npmrc -v ~/.netrc:/home/pisco/.netrc -v ~/.ssh:/home/pisco/.ssh -v `pwd`:/home/pisco/workspace piscosour/cells-bundle&quot;
</code></pre>
<p>The execution of <code>pisco -ft</code> or <code>pisco --functionalTests</code> starts with these messages on stdout. Showing the number of functional testing modules in the recipe, theirs names and versions.</p>
<pre><code class="lang-bash">
[14:32:49] Number of functional testing modules detected:  1
[14:32:49] Executing piscosour functional tests from pisco-functional-tests ( 1.0.15 )


  Pisco context world validation
    ✓ Should return ....
</code></pre>

      </article>
    </section>
    <script type="text/javascript" src="../../js/highlight.pack.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
      $(function(){
      	$('.toggle_section').on('click', function(ev) {
          $(ev.currentTarget).parent('li').toggleClass('open');
        });
      });

    </script>
  </body>
</html>
